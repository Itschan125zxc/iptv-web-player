<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV DRM Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.0/shaka-player.compiled.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; }
        #channel-list { max-width: 600px; margin: 20px auto; text-align: left; padding: 10px; background: #fff; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); }
        .channel { padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer; transition: background 0.3s; }
        .channel:hover { background: #ddd; }
        .active-channel { background: #007bff; color: white; font-weight: bold; }
        video { width: 100%; max-width: 800px; margin-top: 10px; border-radius: 10px; }
    </style>
</head>
<body>
    <h2>IPTV DRM Player (MPD + M3U8)</h2>
    <video id="video" controls autoplay></video>
    
    <h3>Channel List</h3>
    <div id="channel-list"></div>

    <script>
        const channels = [
            { 
                name: "TV 5",
                url: "https://qp-pldt-live-grp-02-prod.akamaized.net/out/u/tv5_hd.mpd",
                type: "mpd",
                keys: { "2615129ef2c846a9bbd43a641c7303ef": "07c7f996b1734ea288641a68e1cfdc4d" }
            },
            { 
                name: "ONE SPORT PH",
                url: "https://qp-pldt-live-grp-07-prod.akamaized.net/out/u/cg_onesports_hd.mpd",
                type: "mpd",
                keys: { "53c3bf2eba574f639aa21f2d4409ff11": "3de28411cf08a64ea935b9578f6d0edd" }
            },
            { 
                name: "ACC Network - HLS (M3U8)",
                url: "https://fl2.moveonjoy.com/ACC_NETWORK/index.m3u8",
                type: "m3u8"
            }
        ];

        const video = document.getElementById("video");
        let player = new shaka.Player(video);
        let hlsPlayer;

        function loadChannel(channel) {
            console.log(`🔄 Switching to: ${channel.name}`);

            // Remove active highlight from all channels
            document.querySelectorAll(".channel").forEach(item => item.classList.remove("active-channel"));

            // Highlight the selected channel
            const selectedChannelElement = [...document.querySelectorAll(".channel")].find(el => el.textContent === channel.name);
            if (selectedChannelElement) selectedChannelElement.classList.add("active-channel");

            if (channel.type === "mpd") {
                if (hlsPlayer) {
                    hlsPlayer.destroy();
                    hlsPlayer = null;
                }

                player.configure({ drm: { clearKeys: channel.keys } });

                player.load(channel.url).then(() => {
                    console.log(`✅ Now playing: ${channel.name}`);
                }).catch(error => console.error("❌ Error loading MPD video", error));

            } else if (channel.type === "m3u8") {
                if (player) {
                    player.unload();
                }

                if (Hls.isSupported()) {
                    console.log("ℹ️ Using HLS.js to load M3U8 stream.");
                    hlsPlayer = new Hls();
                    hlsPlayer.attachMedia(video);
                    hlsPlayer.on(Hls.Events.ERROR, function (event, data) {
                        console.error("❌ HLS.js Error:", data);
                    });

                    hlsPlayer.loadSource(channel.url);
                    hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function () {
                        video.play();
                        console.log("✅ HLS Manifest loaded.");
                    });

                } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                    console.log("ℹ️ Using native HLS support.");
                    video.src = channel.url;
                    video.addEventListener("loadedmetadata", function () {
                        video.play();
                        console.log("✅ HLS Native Loaded.");
                    });

                } else {
                    console.error("❌ HLS is not supported on this browser.");
                }
            }
        }

        function renderChannels() {
            const list = document.getElementById("channel-list");
            channels.forEach((channel, index) => {
                const div = document.createElement("div");
                div.className = "channel";
                div.textContent = channel.name;
                div.onclick = () => loadChannel(channel);
                list.appendChild(div);

                if (index === 0) div.classList.add("active-channel");
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            renderChannels();
            loadChannel(channels[0]);
        });
    </script>
</body>
</html>
